{% extends 'master.html' %}
{% load static %}

{% block styles %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/iCheck/green.css'%}">
{% endblock styles %}


{% block content %}
    <div class="content">
        <div class="box box-success">
            <div class="box-header ui-sortable-handle" style="cursor: move;">
                <i class="ion ion-stats-bars"></i>
                <h3 class="box-title">Dashboard</h3>
                <button type="button" class="btn btn-box-tool pull-right" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
            </div>
            <div class="row">
                <div class="form-group col-xs-6">
                    <label class="col-xs-4">Span:</label>
                    <div class="col-xs-4">
                      <input type="radio" name="span" checked value="area"> Areas
                    </div>
                    <div class="col-xs-4">
                      <input type="radio" name="span" value="city"> Cities
                    </div>
                </div>
                <div class="form-group col-xs-6">
                    <label class="col-xs-4">Periodicity:</label>
                    <div class="col-xs-4">
                      <input type="radio" name="periodicity" checked value="monthly"> Monthly
                    </div>
                    <div class="col-xs-4">
                      <input type="radio" name="periodicity" value="daily"> Daily
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="col-xs-4">
                        <div class="form-group" >
                            <label id="span_label">City</label>
                            <select class="form-control" id="span_select" style="width: 100%;">

                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6" id="periodicity">
                    <div class="col-xs-4">
                        <div class="form-group" >
                            <label id="periodicity_label">Month</label>
                            <select class="form-control" id="month_select" disabled style="width: 100%;">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box-body">
                <div class="chart">
                    <canvas id="barChart" style="height:230px"></canvas>
                </div>
            </div>

        </div>
        <div class="row">
            <div class="col-md-3 col-sm-6 col-xs-12">
              <div class="info-box">
                <span class="info-box-icon bg-aqua">
                    <i class="ion ion-ios-gear-outline"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text">Pending Tickets</span>
                  <span class="info-box-number">{{ open_tickets|length }}</span>
                </div>
                <!-- /.info-box-content -->
              </div>
              <!-- /.info-box -->
            </div>
            <!-- /.col -->
        </div>
          <div class="row">
        <div class="col-md-6">
          <!-- AREA CHART -->
          <div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title">Area Chart</h3>

              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
              </div>
            </div>
            <div class="box-body">
              <div class="chart">
                <canvas id="areaChart" style="height:250px"></canvas>
              </div>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->

          <!-- DONUT CHART -->
           <div class="box box-success">
            <div class="box-header with-border">
              <h3 class="box-title">Bar Chart</h3>

              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
              </div>
            </div>
            <div class="box-body">


            </div>
            <!-- /.box-body -->
          </div>

        </div>
        <!-- /.col (LEFT) -->
        <div class="col-md-6">
            <div class="box box-danger">
            <div class="box-header with-border">
              <h3 class="box-title">Donut Chart</h3>

              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
              </div>
            </div>
            <div class="box-body">
                <div class="col-md-8">
                    <canvas id="pieChart"  style="height:230px"></canvas>
                </div>
                <div class="col-md-4">
                  <ul class="chart-legend clearfix">
                    <li><i class="fa fa-circle-o text-red"></i> Punjab</li>
                    <li><i class="fa fa-circle-o text-green"></i> Sindh</li>
                    <li><i class="fa fa-circle-o text-yellow"></i> Blochistan</li>
                    <li><i class="fa fa-circle-o text-aqua"></i> KPK</li>
                    <li><i class="fa fa-circle-o text-light-blue"></i> Islamabad</li>
                  </ul>
                </div>
            </div>

            <!-- /.box-body -->
          </div>
          <!-- BAR CHART -->

          <!-- /.box -->

        </div>
        <!-- /.col (RIGHT) -->
        </div>
    </div>

{% endblock content %}



{% block script %}
    <script src="{% static 'js/iCheck/icheck.min.js' %}"></script>
    <script>

    const jsonConfig = {{ json_conifg|safe }};
    const monthNames = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
    ];
    $('#span_label').text("Area").val('area');
    $('#span_select').empty().html(jsonConfig.reduce(area_selector, ''));

    function city_selector(html, city){
        return html + "<option " + (!city.areas.length?"disabled=\"disabled\"":"") +
            " value=" + city.id + ">" + city.city_name + "</option>"
    }

    function area_options(html, area) {
        return html + "<option " + (!area.meters.length?"disabled=\"disabled\"":"") +
            " value=" + area.id + ">" + area.area_name + "</option>"
    }

    function area_selector(html, city) {
        return html + (city.areas.length? "<optgroup label=\"" + city.city_name + "\">\n" +
            city.areas.reduce(area_options, '') + "</optgroup>" : null);
    }

    let barChartData = {
        type: 'bar',
        data: {
            labels: monthNames,
            datasets: [
                {
                    label: 'Consumptions',
                    fillColor: '#00a65a',
                    strokeColor: '#00a65a',
                    pointColor: '#00a65a',
                    pointStrokeColor: 'rgba(60,141,188,1)',
                    pointHighlightFill: '#fff',
                    pointHighlightStroke: 'rgba(60,141,188,1)',
                    data: []
                }
            ]
        },
        options:  {
          //Boolean - Whether the scale should start at zero, or an order of magnitude down from the lowest value
          scaleBeginAtZero        : true,
          //Boolean - Whether grid lines are shown across the chart
          scaleShowGridLines      : true,
          //String - Colour of the grid lines
          scaleGridLineColor      : 'rgba(0,0,0,.05)',
          //Number - Width of the grid lines
          scaleGridLineWidth      : 1,
          //Boolean - Whether to show horizontal lines (except X axis)
          scaleShowHorizontalLines: true,
          //Boolean - Whether to show vertical lines (except Y axis)
          scaleShowVerticalLines  : true,
          //Boolean - If there is a stroke on each bar
          barShowStroke           : true,
          //Number - Pixel width of the bar stroke
          barStrokeWidth          : 2,
          //Number - Spacing between each of the X value sets
          barValueSpacing         : 5,
          //Number - Spacing between data sets within X values
          barDatasetSpacing       : 1,
          //String - A legend template
          legendTemplate          : '<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){\\%><li><span style="background-color:<%=datasets[i].fillColor%>"></span><%if(datasets[i].label){\\%><%=datasets[i].label%><%}%></li><%}%></ul>',
          //Boolean - whether to make the chart responsive
          responsive              : true,
          maintainAspectRatio     : true
        }
    };
    let barChart = new Chart($('#barChart'), barChartData);

    function showBarChart() {
        let periodicity = $('#periodicity_label').val();
        if (!periodicity) periodicity = "monthly";
        let span = $('#span_label, #span_select').val();
        let spanId = $('#span_select').val();
        let month = $('#month_select').val();

        let summaryParams = `?span=${span}&span_id=${spanId}`;
        if (periodicity==='daily') summaryParams += `&month=${month}`;
        $.get(`/api/consumptions/summarize${summaryParams}`,{
            headers: {
                Authorization: 'Token 59634c196f1be3389f4718c20b137d22d6c248b7'
            }
        }).then(data => {
            barChart.data.labels = periodicity==='daily'? data.map((v,i)=>`${i+1}/${month}`): monthNames;
            barChart.data.datasets[0].data = data.map(item=>item.load);
            barChart.update();
        })
    }

    $('input[name="span"]').iCheck({
        radioClass: 'iradio_flat-green'
    }).on('ifChecked', event => {
        let span = event.target.value;
        let select_options;
        if(span==="city"){
            select_options = jsonConfig.reduce(city_selector, '');
            $('#span_label').text("City").val(span)
        }
        else if(span==="area")
        {
            select_options = jsonConfig.reduce(area_selector, '');
            $('#span_label').text("Area").val(span)
        }

        $('#span_select').empty().html(select_options);
        showBarChart();
    });

    $('input[name="periodicity"]').iCheck({
        radioClass: 'iradio_flat-green'
    }).on('ifChecked', event => {
        $('#month_select').prop('disabled', (i, v) => !v);
        $('#periodicity_label').val(event.target.value);
        showBarChart();
    });

    $('#month_select, #span_select').on('change', showBarChart);
    $(showBarChart)
    </script>
{% endblock script %}